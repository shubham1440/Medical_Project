<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title>Clinical Command Center | Gopal Hospital</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4361ee; --dark-panel: #0f172a; --glass: rgba(255, 255, 255, 0.95); }
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .cockpit-header { background: var(--dark-panel); color: white; padding: 4rem 2rem 8rem 2rem; border-radius: 0 0 3rem 3rem; margin-bottom: -5rem; }
        .glass-card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.4); border-radius: 2rem; padding: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); height: 100%; }
        .status-pulse { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; display: inline-block; margin-right: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .timeline-item { border-left: 2px dashed #cbd5e1; padding-left: 1.5rem; position: relative; padding-bottom: 1.5rem; }
        .timeline-item::before { content: ''; position: absolute; left: -7px; top: 0; width: 12px; height: 12px; background: #000; border-radius: 50%; }
        .btn-black { background-color: #000 !important; border-color: #000 !important; color: #fff !important; }
        .tab-nav-container { margin-top: -4.5rem; position: relative; z-index: 1001; }
        #searchResults { top: 100%; left: 0; right: 0; border-radius: 1rem; border: 1px solid rgba(0,0,0,0.1); background: white; z-index: 1100; max-height: 250px; overflow-y: auto; }

        /* Modal Split View */
        #viewModal .modal-dialog { max-width: 95vw; height: 90vh; margin: 2vh auto; }
        #viewModal .modal-content { height: 100%; border-radius: 24px; border: none; overflow: hidden; }
        .split-view { display: flex; height: 100%; }
        .pdf-area { flex: 2; background: #334155; }
        .notes-area { flex: 1; background: white; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="cockpit-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-7">
                    <div class="d-flex align-items-center mb-3">
                        <span class="status-pulse"></span>
                        <small class="text-success fw-bold text-uppercase">Live Connection â€¢ Nominal</small>
                    </div>
                    <h1 class="display-5 fw-bold mb-2">Systems Terminal, Dr. <span th:text="${username}">User</span></h1>
                    <p class="lead opacity-75">You have <span class="text-info fw-bold" th:text="${todaysAppointments}">0</span> patients today.</p>
                </div>
                <div class="col-md-5 text-end">
                    <div class="d-inline-flex gap-3 bg-white bg-opacity-10 p-3 rounded-4">
                        <div class="text-center px-3 border-end border-white border-opacity-25">
                            <h3 class="mb-0 fw-bold" th:text="${pendingActions}">0</h3>
                            <small class="opacity-50 text-uppercase">Requests</small>
                        </div>
                        <div class="text-center px-3">
                            <h3 class="mb-0 fw-bold" th:text="${#temporals.format(#temporals.createNow(), 'dd MMM')}">Today</h3>
                            <small class="opacity-50 text-uppercase">Date</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container tab-nav-container mb-4">
        <div class="row">
            <div class="col-12 text-center">
                <div class="btn-group bg-white p-2 rounded-pill shadow-lg">
                    <button type="button" class="btn btn-black rounded-pill px-4 me-2 nav-link-custom active" id="btnNavWorklist">Worklist</button>
                    <button type="button" class="btn btn-light rounded-pill px-4 me-2 nav-link-custom" id="btnNavRaise">Raise Consent</button>
                    <button type="button" class="btn btn-light rounded-pill px-4 nav-link-custom" id="btnNavStatus">Consent Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <div id="sectionWorklist" class="row g-4 mt-2">
            <div class="col-lg-8">
                <div class="glass-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold mb-0"><i class="bi bi-activity me-2"></i>Active Worklist</h4>
                        <a th:href="@{/provider/worklist}" class="btn btn-black rounded-pill btn-sm px-4">Full Worklist</a>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-borderless align-middle">
                            <thead class="text-muted small text-uppercase">
                            <tr><th>Patient</th><th>Status</th><th>Time</th><th class="text-end">Manage</th></tr>
                            </thead>
                            <tbody>
                            <tr th:each="appt : ${appointments}" class="border-bottom">
                                <td class="fw-bold py-3" th:text="${appt.patientName}">Name</td>
                                <td><span class="badge bg-dark text-white rounded-pill px-3" th:text="${appt.status}">Status</span></td>
                                <td th:text="${appt.startTime}">Time</td>
                                <td class="text-end"><a th:href="@{/provider/worklist}" class="btn btn-light btn-sm rounded-circle"><i class="bi bi-chevron-right"></i></a></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="glass-card">
                    <h5 class="fw-bold mb-4">Upcoming Queue</h5>
                    <div class="timeline">
                        <div th:each="appt : ${appointments}" class="timeline-item">
                            <div class="small text-muted" th:text="${appt.startTime}"></div>
                            <div class="fw-bold" th:text="${appt.patientName}"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mt-4">
                <div class="glass-card text-center d-flex flex-column justify-content-center">
                    <div class="text-dark mb-2 fs-3"><i class="bi bi-people-fill"></i></div>
                    <h2 class="fw-bold mb-0" th:text="${assignedPatients ?: '0'}">0</h2>
                    <small class="text-muted text-uppercase tracking-wider">Total Patient Panel</small>
                </div>
            </div>
            <div class="col-md-8 mt-4">
                <div class="glass-card">
                    <div class="row align-items-center">
                        <div class="col-md-6 border-end">
                            <h5 class="fw-bold mb-3">Compliance & Docs</h5>
                            <div class="progress mb-2" style="height: 8px; border-radius: 10px;"><div class="progress-bar bg-dark" style="width: 75%"></div></div>
                            <small class="text-muted">75% of charts finalized</small>
                        </div>
                        <div class="col-md-6 ps-md-4">
                            <h5 class="fw-bold mb-3">Pending Requests</h5>
                            <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded-4">
                                <div><h4 class="mb-0 fw-bold" th:text="${pendingActions}">0</h4><small class="text-muted">New requests</small></div>
                                <a th:href="@{/provider/pending}" class="btn btn-black btn-sm rounded-pill px-3">Review</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="sectionRaise" class="row d-none mt-2">
            <div class="col-12">
                <div class="glass-card border-0 shadow-lg">
                    <form id="consentRequestForm">
                        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                        <div class="row g-3">
                            <div class="col-12 d-flex align-items-center mb-2">
                                <div class="bg-dark bg-opacity-10 p-2 rounded-3 me-3 text-dark"><i class="bi bi-shield-lock-fill fs-4"></i></div>
                                <h5 class="fw-bold mb-0">Structured Access Request</h5>
                            </div>
                            <div class="col-md-4 position-relative">
                                <label class="small fw-bold text-muted text-uppercase">Patient Search</label>
                                <input type="hidden" name="patientId" id="hiddenPatientId">
                                <div class="input-group shadow-sm rounded-3 overflow-hidden">
                                    <span class="input-group-text border-0 bg-light pe-0"><i class="bi bi-search text-muted"></i></span>
                                    <input type="text" id="patientSearchInput" class="form-control border-0 bg-light py-2" placeholder="Search Patient..." autocomplete="off">
                                </div>
                                <div id="searchResults" class="list-group position-absolute d-none"></div>
                            </div>
                            <div class="col-md-8">
                                <label class="small fw-bold text-muted text-uppercase">Clinical Reason</label>
                                <input type="text" id="clinicalReason" class="form-control border-0 bg-light rounded-3 py-2" placeholder="Reason for access..." required>
                            </div>
                            <div class="col-12">
                                <div id="itemsContainer" class="p-3 rounded-4 border border-dashed">
                                    <div class="row g-2 mb-2 item-row">
                                        <div class="col-md-5">
                                            <select class="form-select border-0 bg-light category-select">
                                                <option value="" disabled selected>Category...</option>
                                                <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat}"></option>
                                            </select>
                                        </div>
                                        <div class="col-md-5">
                                            <select class="form-select border-0 bg-light subtype-select"><option disabled selected>Select Type...</option></select>
                                        </div>
                                        <div class="col-md-2"><button type="button" id="addItemBtn" class="btn btn-outline-dark w-100 rounded-3"><i class="bi bi-plus-lg"></i></button></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 text-end"><button type="submit" class="btn btn-black rounded-pill fw-bold px-5 py-2">Transmit Request</button></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

<!--        <div id="sectionStatus" class="row g-4 d-none mt-2">-->
<!--            <div class="col-lg-6">-->
<!--                <div class="glass-card">-->
<!--                    <h5 class="fw-bold mb-4 text-success"><i class="bi bi-check-all me-2"></i>Active Permissions</h5>-->
<!--                    <div th:each="consent : ${activeConsent}" class="bg-light p-3 rounded-4 mb-3 border-start border-success border-4 shadow-sm">-->
<!--                        <div class="d-flex justify-content-between">-->
<!--                            <h6 class="fw-bold mb-1" th:text="${consent.patientName}">Patient Name</h6>-->
<!--                            <span class="badge bg-dark rounded-pill" th:text="${consent.permissionType}">VIEW</span>-->
<!--                        </div>-->
<!--                        <div class="small text-muted mb-1"><i class="bi bi-shield-lock me-1"></i> Role: <span th:text="${consent.grantedRole}">PROVIDER</span></div>-->
<!--                        <div class="mt-1 small text-muted">-->
<!--                            <i class="bi bi-clock me-1"></i> Granted:-->
<!--                            <span th:text="${consent.grantedAt != null && #strings.contains(consent.grantedAt, 'T') ? #strings.substring(consent.grantedAt, 0, 10) + ' ' + #strings.substring(consent.grantedAt, 11, 16) : consent.grantedAt}">&#45;&#45;</span>-->
<!--                        </div>-->
<!--                        <div class="small text-danger" th:if="${consent.revokedAt != null}">-->
<!--                            <i class="bi bi-calendar-x me-1"></i> Revoke At: <span th:text="${#strings.substring(consent.revokedAt,0,10) + ' ' + #strings.substring(consent.revokedAt,11,16)}"></span>-->
<!--                        </div>-->
<!--                        <div class="mt-3">-->
<!--                            <button class="btn btn-black btn-sm w-100 rounded-pill open-viewer-btn"-->
<!--                                    th:data-doc-id="${consent.id}"-->
<!--                                    th:data-patient-name="${consent.patientName}">-->
<!--                                <i class="bi bi-file-earmark-medical me-2"></i>View Document-->
<!--                            </button>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--            <div class="col-lg-6">-->
<!--                <div class="glass-card">-->
<!--                    <h5 class="fw-bold mb-4 text-primary"><i class="bi bi-broadcast me-2"></i>Requests Transmitted</h5>-->
<!--                    <div th:each="req : ${pendingConsent}" class="bg-white border p-3 rounded-4 mb-3 shadow-sm">-->
<!--                        <div class="d-flex justify-content-between mb-2 small text-muted">-->
<!--                            <span class="badge rounded-pill fw-bold"-->
<!--                                  th:classappend="${req.status.name() == 'DENIED' ? 'bg-danger-subtle text-danger border border-danger-subtle' :-->
<!--                                                   req.status.name() == 'PENDING' ? 'bg-warning-subtle text-warning-emphasis border border-warning-subtle' :-->
<!--                                                   'bg-success-subtle text-success border border-success-subtle'}"-->
<!--                                  th:text="${req.status}"-->
<!--                                  style="font-size: 0.75rem; letter-spacing: 0.03em;">-->
<!--                            </span>-->
<!--                            <div class="mt-1 small text-muted">-->
<!--                                <i class="bi bi-clock me-1"></i> Rasied At:-->
<!--                                <span th:text="${#strings.substring(req.createdAt,0,10) + ' ' + #strings.substring(req.createdAt,11,16)}"></span>-->
<!--                            </div>-->

<!--                        </div>-->

<!--                        <p class="fw-bold mb-0" th:text="${req.reason ?: 'Clinical Access Request'}"></p>-->

<!--                        <div class="d-flex flex-wrap gap-2">-->
<!--                        <span th:each="item : ${req.items}" class="badge bg-light text-dark border border-secondary-subtle fw-normal px-2 py-1">-->
<!--                            <i class="bi bi-file-earmark-medical me-1"></i>-->
<!--                            <span th:text="${item.category + ' - ' + item.subType}">Prescriptions</span>-->
<!--                        </span>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
        <div id="sectionStatus" class="row g-4 d-none mt-2">
            <div class="col-lg-6">
                <div class="glass-card">
                    <h5 class="fw-bold mb-4 text-success"><i class="bi bi-check-all me-2"></i>Active Permissions</h5>
                    <div th:each="consent : ${activeConsent}" class="bg-light p-3 rounded-4 mb-3 border-start border-success border-4 shadow-sm">
                        <div class="d-flex justify-content-between">
                            <h6 class="fw-bold mb-1" th:text="${consent.patientName}">Patient Name</h6>
                            <span class="badge bg-dark rounded-pill" th:text="${consent.permissionType}">VIEW</span>
                        </div>
                        <div class="small text-muted mb-1"><i class="bi bi-shield-lock me-1"></i> Role: <span th:text="${consent.grantedRole}">PROVIDER</span></div>
                        <div class="mt-1 small text-muted">
                            <i class="bi bi-clock me-1"></i> Granted:
                            <span th:text="${consent.grantedAt != null && #strings.contains(consent.grantedAt, 'T') ? #strings.substring(consent.grantedAt, 0, 10) + ' ' + #strings.substring(consent.grantedAt, 11, 16) : consent.grantedAt}">--</span>
                        </div>
                        <div class="small text-danger" th:if="${consent.revokedAt != null}">
                            <i class="bi bi-calendar-x me-1"></i> Revoke At: <span th:text="${#strings.substring(consent.revokedAt,0,10) + ' ' + #strings.substring(consent.revokedAt,11,16)}"></span>
                        </div>
                        <div class="mt-3">
                            <button type="button"
                                    class="btn btn-black btn-sm w-100 rounded-pill open-viewer-btn"
                                    th:data-doc-id="${consent.id}"
                                    th:data-patient-name="${consent.patientName}"
                                    th:data-doc-notes="${consent.notes}">
                                <i class="bi bi-file-earmark-medical me-2"></i>View Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="glass-card">
                    <h5 class="fw-bold mb-4 text-primary"><i class="bi bi-broadcast me-2"></i>Requests Transmitted</h5>
                    <div th:each="req : ${pendingConsent}" class="bg-white border p-3 rounded-4 mb-3 shadow-sm">
                        <div class="d-flex justify-content-between mb-2 small text-muted">
                    <span class="badge rounded-pill fw-bold"
                          th:classappend="${req.status.name() == 'DENIED' ? 'bg-danger-subtle text-danger border border-danger-subtle' :
                                           req.status.name() == 'PENDING' ? 'bg-warning-subtle text-warning-emphasis border border-warning-subtle' :
                                           'bg-success-subtle text-success border border-success-subtle'}"
                          th:text="${req.status}"
                          style="font-size: 0.75rem; letter-spacing: 0.03em;">
                    </span>
                            <div class="mt-1 small text-muted">
                                <i class="bi bi-clock me-1"></i> Raised At:
                                <span th:text="${#strings.substring(req.createdAt,0,10) + ' ' + #strings.substring(req.createdAt,11,16)}"></span>
                            </div>
                        </div>
                        <p class="fw-bold mb-0" th:text="${req.reason ?: 'Clinical Access Request'}"></p>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                    <span th:each="item : ${req.items}" class="badge bg-light text-dark border border-secondary-subtle fw-normal px-2 py-1">
                        <i class="bi bi-file-earmark-medical me-1"></i>
                        <span th:text="${item.category + ' - ' + item.subType}">Prescriptions</span>
                    </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div th:replace="~{fragments/viewer-fragment :: documentViewer}"></div>
    </div>

    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="split-view">
                    <div class="pdf-area"><iframe id="viewerFrame" src=""></iframe></div>
                    <div class="notes-area">
                        <div class="p-4 border-bottom d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0" id="viewerTitle">Examine Record</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="p-4 flex-grow-1 overflow-auto">
                            <label class="small fw-bold text-muted text-uppercase mb-2">Findings</label>
                            <textarea id="clinicalNotes" class="form-control border-0 bg-light rounded-4" rows="12" placeholder="Enter notes..."></textarea>
                        </div>
                        <div class="p-4 bg-light text-center"><button class="btn btn-black w-100 py-3 rounded-pill fw-bold">Save Observation</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!--    <script th:inline="javascript">-->
<!--        /*<![CDATA[*/-->
<!--        document.addEventListener('DOMContentLoaded', function() {-->
<!--            const categoryData = /*[[${categoryMap}]]*/ {};-->
<!--            const searchInput = document.getElementById('patientSearchInput');-->
<!--            const resultsBox = document.getElementById('searchResults');-->
<!--            const hiddenIdInput = document.getElementById('hiddenPatientId');-->
<!--            const container = document.getElementById('itemsContainer');-->
<!--            let searchTimeout;-->

<!--            // 1. Tab Navigation-->
<!--            const sections = { worklist: document.getElementById('sectionWorklist'), raise: document.getElementById('sectionRaise'), status: document.getElementById('sectionStatus') };-->
<!--            const navBtns = { worklist: document.getElementById('btnNavWorklist'), raise: document.getElementById('btnNavRaise'), status: document.getElementById('btnNavStatus') };-->
<!--            function switchTab(t) { Object.keys(sections).forEach(k => { sections[k].classList.add('d-none'); navBtns[k].classList.replace('btn-black', 'btn-light'); }); sections[t].classList.remove('d-none'); navBtns[t].classList.replace('btn-light', 'btn-black'); }-->
<!--            navBtns.worklist.onclick = () => switchTab('worklist');-->
<!--            navBtns.raise.onclick = () => switchTab('raise');-->
<!--            navBtns.status.onclick = () => switchTab('status');-->

<!--            // 2. Patient Search-->
<!--            if (searchInput) {-->
<!--                searchInput.addEventListener('input', function() {-->
<!--                    clearTimeout(searchTimeout);-->
<!--                    const q = this.value;-->
<!--                    if (q.length < 2) { resultsBox.classList.add('d-none'); return; }-->
<!--                    searchTimeout = setTimeout(async () => {-->
<!--                        const res = await fetch(`/patients/search?query=${encodeURIComponent(q)}`);-->
<!--                        const data = await res.json();-->
<!--                        resultsBox.innerHTML = '';-->
<!--                        if (data.length > 0) {-->
<!--                            resultsBox.classList.remove('d-none');-->
<!--                            data.forEach(p => {-->
<!--                                const btn = document.createElement('button');-->
<!--                                btn.type = 'button';-->
<!--                                btn.className = 'list-group-item list-group-item-action';-->
<!--                                btn.innerHTML = `<strong>${p.firstName} ${p.lastName}</strong> <small class="text-muted">ID: ${p.id}</small>`;-->
<!--                                btn.onclick = () => { hiddenIdInput.value = p.id; searchInput.value = `${p.firstName} ${p.lastName}`; resultsBox.classList.add('d-none'); };-->
<!--                                resultsBox.appendChild(btn);-->
<!--                            });-->
<!--                        }-->
<!--                    }, 300);-->
<!--                });-->
<!--            }-->

<!--            // 3. Form Logic-->
<!--            if (container) {-->
<!--                container.addEventListener('change', (e) => {-->
<!--                    if (e.target.classList.contains('category-select')) {-->
<!--                        const sub = e.target.closest('.item-row').querySelector('.subtype-select');-->
<!--                        sub.innerHTML = '<option value="" disabled selected>Select Type...</option>';-->
<!--                        (categoryData[e.target.value] || []).forEach(t => sub.add(new Option(t.label || t, t.id || t)));-->
<!--                    }-->
<!--                });-->
<!--                document.getElementById('addItemBtn').onclick = () => {-->
<!--                    const row = container.querySelector('.item-row').cloneNode(true);-->
<!--                    row.querySelector('.subtype-select').innerHTML = '<option value="" disabled selected>Select Type...</option>';-->
<!--                    row.querySelector('.col-md-2').innerHTML = '<button type="button" class="btn btn-outline-danger w-100 rounded-3 remove-btn"><i class="bi bi-trash"></i></button>';-->
<!--                    container.appendChild(row);-->
<!--                };-->
<!--                container.onclick = (e) => { if(e.target.closest('.remove-btn')) e.target.closest('.item-row').remove(); };-->
<!--            }-->

<!--            // 4. Submission Logic (NEW)-->
<!--            const consentForm = document.getElementById('consentRequestForm');-->
<!--            if(consentForm) {-->
<!--                consentForm.addEventListener('submit', async (e) => {-->
<!--                    e.preventDefault();-->

<!--                    const items = [];-->
<!--                    document.querySelectorAll('.item-row').forEach(row => {-->
<!--                        const cat = row.querySelector('.category-select').value;-->
<!--                        const sub = row.querySelector('.subtype-select').value;-->
<!--                        if (cat && sub) {-->
<!--                            items.push({ category: cat, subType: sub });-->
<!--                        }-->
<!--                    });-->

<!--                    const dto = {-->
<!--                        patientId: parseInt(document.getElementById('hiddenPatientId').value),-->
<!--                        reason: document.getElementById('clinicalReason').value,-->
<!--                        items: items-->
<!--                    };-->

<!--                    if (isNaN(dto.patientId)) { alert("Please select a patient."); return; }-->
<!--                    if (items.length === 0) { alert("Please add at least one category/type."); return; }-->

<!--                    try {-->
<!--                        const csrfToken = document.querySelector('input[name="_csrf"]')?.value;-->
<!--                        const response = await fetch('/consents/request', {-->
<!--                            method: 'POST',-->
<!--                            headers: {-->
<!--                                'Content-Type': 'application/json',-->
<!--                                'X-CSRF-TOKEN': csrfToken-->
<!--                            },-->
<!--                            body: JSON.stringify(dto)-->
<!--                        });-->

<!--                        if (response.ok) {-->
<!--                            alert("Request Transmitted Successfully!");-->
<!--                            window.location.reload();-->
<!--                        } else {-->
<!--                            const err = await response.text();-->
<!--                            alert("Error: " + err);-->
<!--                        }-->
<!--                    } catch (error) {-->
<!--                        alert("Network error occurred.");-->
<!--                    }-->
<!--                });-->
<!--            }-->

<!--&lt;!&ndash;            // 5. Modal&ndash;&gt;-->
<!--            const viewModal = new bootstrap.Modal(document.getElementById('viewModal'));-->
<!--            const viewerFrame = document.getElementById('viewerFrame');-->
<!--            document.querySelectorAll('.open-viewer-btn').forEach(btn => {-->
<!--                btn.onclick = function() {-->
<!--                    viewerFrame.src = "/documents/" + this.getAttribute('data-doc-id');-->
<!--                    document.getElementById('viewerTitle').innerText = "Record: " + this.getAttribute('data-patient-name');-->
<!--                    viewModal.show();-->
<!--                };-->
<!--            });-->
<!--            document.getElementById('viewModal').addEventListener('hidden.bs.modal', () => { viewerFrame.src = ''; });-->
<!--        });-->
<!--        /*]]>*/-->
<!--    </script>-->
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            const categoryData = /*[[${categoryMap}]]*/ {};
            const searchInput = document.getElementById('patientSearchInput');
            const resultsBox = document.getElementById('searchResults');
            const hiddenIdInput = document.getElementById('hiddenPatientId');
            const container = document.getElementById('itemsContainer');
            let searchTimeout;

            // 1. Tab Navigation
            const sections = {
                worklist: document.getElementById('sectionWorklist'),
                raise: document.getElementById('sectionRaise'),
                status: document.getElementById('sectionStatus')
            };
            const navBtns = {
                worklist: document.getElementById('btnNavWorklist'),
                raise: document.getElementById('btnNavRaise'),
                status: document.getElementById('btnNavStatus')
            };

            function switchTab(t) {
                Object.keys(sections).forEach(k => {
                    if(sections[k]) sections[k].classList.add('d-none');
                    if(navBtns[k]) navBtns[k].classList.replace('btn-black', 'btn-light');
                });
                if(sections[t]) sections[t].classList.remove('d-none');
                if(navBtns[t]) navBtns[t].classList.replace('btn-light', 'btn-black');
            }

            navBtns.worklist.onclick = () => switchTab('worklist');
            navBtns.raise.onclick = () => switchTab('raise');
            navBtns.status.onclick = () => switchTab('status');

            // 2. Patient Search
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const q = this.value;
                    if (q.length < 2) { resultsBox.classList.add('d-none'); return; }
                    searchTimeout = setTimeout(async () => {
                        try {
                            const res = await fetch(`/patients/search?query=${encodeURIComponent(q)}`);
                            const data = await res.json();
                            resultsBox.innerHTML = '';
                            if (data.length > 0) {
                                resultsBox.classList.remove('d-none');
                                data.forEach(p => {
                                    const btn = document.createElement('button');
                                    btn.type = 'button';
                                    btn.className = 'list-group-item list-group-item-action';
                                    btn.innerHTML = `<strong>${p.firstName} ${p.lastName}</strong> <small class="text-muted">ID: ${p.id}</small>`;
                                    btn.onclick = () => {
                                        hiddenIdInput.value = p.id;
                                        searchInput.value = `${p.firstName} ${p.lastName}`;
                                        resultsBox.classList.add('d-none');
                                    };
                                    resultsBox.appendChild(btn);
                                });
                            }
                        } catch (err) { console.error("Search error:", err); }
                    }, 300);
                });
            }

            // 3. Form Logic (Dynamic Rows)
            if (container) {
                container.addEventListener('change', (e) => {
                    if (e.target.classList.contains('category-select')) {
                        const sub = e.target.closest('.item-row').querySelector('.subtype-select');
                        sub.innerHTML = '<option value="" disabled selected>Select Type...</option>';
                        (categoryData[e.target.value] || []).forEach(t => sub.add(new Option(t.label || t, t.id || t)));
                    }
                });
                document.getElementById('addItemBtn').onclick = () => {
                    const row = container.querySelector('.item-row').cloneNode(true);
                    row.querySelector('.subtype-select').innerHTML = '<option value="" disabled selected>Select Type...</option>';
                    row.querySelector('.col-md-2').innerHTML = '<button type="button" class="btn btn-outline-danger w-100 rounded-3 remove-btn"><i class="bi bi-trash"></i></button>';
                    container.appendChild(row);
                };
                container.onclick = (e) => { if(e.target.closest('.remove-btn')) e.target.closest('.item-row').remove(); };
            }

            // 4. Submission Logic
            const consentForm = document.getElementById('consentRequestForm');
            if(consentForm) {
                consentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const items = [];
                    document.querySelectorAll('.item-row').forEach(row => {
                        const cat = row.querySelector('.category-select').value;
                        const sub = row.querySelector('.subtype-select').value;
                        if (cat && sub) items.push({ category: cat, subType: sub });
                    });

                    const dto = {
                        patientId: parseInt(document.getElementById('hiddenPatientId').value),
                        reason: document.getElementById('clinicalReason').value,
                        items: items
                    };

                    if (isNaN(dto.patientId)) { alert("Please select a patient."); return; }
                    if (items.length === 0) { alert("Please add at least one item."); return; }

                    try {
                        const csrfToken = document.querySelector('input[name="_csrf"]')?.value;
                        const response = await fetch('/consents/request', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': csrfToken },
                            body: JSON.stringify(dto)
                        });

                        if (response.ok) {
                            alert("Request Transmitted!");
                            window.location.reload();
                        } else {
                            alert("Error: " + await response.text());
                        }
                    } catch (error) { alert("Network error."); }
                });
            }
        }); // Correctly closing DOMContentLoaded
        /*]]>*/
    </script>
</div>
</body>
</html>