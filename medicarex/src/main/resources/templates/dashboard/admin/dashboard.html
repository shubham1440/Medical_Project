<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:fragment="title">Command Center | Gopal Hospital</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        .command-card {
            background: #ffffff;
            border-radius: 32px;
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 10px 40px -12px rgba(0,0,0,0.05);
            padding: 1.8rem;
            height: 100%;
        }

        /* FIXED WIDTH TIMER PREVENTS JUMPING */
        #current-time {
            font-family: 'Courier New', Courier, monospace;
            font-variant-numeric: tabular-nums;
            min-width: 120px;
            display: inline-block;
            text-align: center;
        }

        .staff-avatar {
            width: 45px; height: 45px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 0.9rem;
            border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .status-badge {
            width: 12px; height: 12px;
            border-radius: 50%; border: 2px solid #fff;
            position: absolute; bottom: -2px; right: -2px;
        }

        .attendance-row, .patient-row {
            padding: 12px; border-radius: 18px;
            display: flex; align-items: center; gap: 12px; transition: 0.2s;
        }
        .attendance-row:hover, .patient-row:hover { background: #f8fafc; }

        .search-inner {
            background: #f1f5f9; border-radius: 15px;
            padding: 8px 15px; display: flex; align-items: center; gap: 10px;
        }

        .telemetry-chip {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 50px;
            padding: 8px 18px; display: flex; align-items: center; gap: 10px;
            font-size: 0.8rem; font-weight: 700;
        }

        .chart-container { position: relative; height: 300px; width: 100%; }
        .scroll-section { max-height: 320px; overflow-y: auto; scrollbar-width: thin; }
    </style>
</head>
<body>
<div layout:fragment="content">

    <div class="row align-items-center mb-5">
        <div class="col-lg-5">
            <h1 class="fw-800 text-dark mb-1" style="font-size: 2.3rem; letter-spacing: -1.5px;">Control Center</h1>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary text-white rounded-pill px-3">ADMIN PORTAL</span>
                <small class="text-muted fw-bold">Sunday, Dec 21, 2025</small>
            </div>
        </div>
        <div class="col-lg-7 text-lg-end mt-3 mt-lg-0">
            <div class="d-inline-flex flex-wrap gap-2">
                <div class="telemetry-chip bg-white shadow-sm border-0" style="padding: 8px 25px;">
                    <i class="bi bi-clock-fill text-primary"></i>
                    <span id="current-time" class="text-dark fw-bold">--:--:-- --</span>
                </div>
                <div class="telemetry-chip bg-dark text-white border-0">
                    <i class="bi bi-shield-check me-1"></i> SYSTEM SECURE
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="command-card">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h5 class="fw-800 text-dark m-0">Patient Traffic Analytics</h5>
                        <p class="text-muted small fw-600">Real-time inflow monitoring</p>
                    </div>
                    <div class="text-end">
                        <button onclick="downloadChartCSV()" class="btn btn-outline-primary btn-sm rounded-pill px-3 fw-bold mb-2">
                            <i class="bi bi-download me-1"></i> CSV
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="refinedChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="command-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-800 m-0">Duty Roster</h6>
                    <span id="onlineCountBadge" class="badge bg-success-subtle text-success border-0 px-2">Loading...</span>
                </div>
                <div class="search-inner mb-4">
                    <i class="bi bi-search text-muted"></i>
                    <input type="text" id="providerSearch" onkeyup="liveSearch('providerSearch', 'staff-item', 'staff-name')" class="form-control border-0 bg-transparent small p-0" placeholder="Search providers...">
                </div>

                <div class="scroll-section" id="dutyRosterContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                        <p class="text-muted small mt-2">Syncing Roster...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
<!--        <div class="col-lg-6">-->
<!--            <div class="command-card border-start border-4 border-info">-->
<!--                <div class="d-flex justify-content-between align-items-center mb-4">-->
<!--                    <h6 class="fw-800 m-0"><i class="bi bi-person-heart text-info me-2"></i>Patient Registry</h6>-->
<!--                    <a th:href="@{/admin/patients/new}" class="btn btn-info btn-sm text-white rounded-pill px-3 fw-bold">Add New</a>-->
<!--                </div>-->
<!--                <div class="search-inner mb-3">-->
<!--                    <i class="bi bi-search text-muted"></i>-->
<!--                    <input type="text" id="patientSearchInput" onkeyup="liveSearch('patientSearchInput', 'patient-item', 'patient-name')" class="form-control border-0 bg-transparent small p-0" placeholder="ID or Name...">-->
<!--                </div>-->
<!--                <div class="scroll-section" style="max-height: 150px;">-->
<!--                    <div class="patient-row patient-item">-->
<!--                        <i class="bi bi-person-circle fs-5 text-muted"></i>-->
<!--                        <div class="flex-grow-1">-->
<!--                            <span class="d-block fw-bold text-dark small patient-name">Rahul Sharma (ID: 1024)</span>-->
<!--                            <small class="text-muted">General Checkup</small>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
    <div class="col-lg-6">
        <div class="command-card border-start border-4 border-info">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h6 class="fw-800 m-0"><i class="bi bi-person-heart text-info me-2"></i>Patient Registry</h6>
                <a th:href="@{/admin/patients/new}" class="btn btn-info btn-sm text-white rounded-pill px-3 fw-bold">Add New</a>
            </div>
            <div class="search-inner mb-3">
                <i class="bi bi-search text-muted"></i>
                <input type="text" id="patientSearchInput"
                       onkeyup="liveSearch('patientSearchInput', 'patient-item', 'patient-name')"
                       class="form-control border-0 bg-transparent small p-0"
                       placeholder="ID or Name...">
            </div>
            <div class="scroll-section" id="patientRegistryContainer" style="max-height: 150px;">
                <div class="text-center py-4">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                </div>
            </div>
        </div>
    </div>


        <div class="col-lg-6">
            <div class="command-card bg-primary text-white border-0 shadow-lg" style="background: linear-gradient(135deg, #0f4c81 0%, #082f49 100%) !important;">
                <h6 class="fw-bold mb-4 opacity-75 text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">Directives</h6>
                <div class="row g-3">
                    <div class="col-6">
                        <a th:href="@{/admin/providers/new}" class="btn btn-white w-100 py-3 rounded-4 d-flex flex-column align-items-center gap-2 border-0">
                            <i class="bi bi-person-badge-fill text-primary fs-4"></i>
                            <span class="fw-bold small text-dark">Add Provider</span>
                        </a>
                    </div>
                    <div class="col-6">
                        <a th:href="@{/admin/users/bulk-import}" class="btn btn-outline-light w-100 py-3 rounded-4 d-flex flex-column align-items-center gap-2">
                            <i class="bi bi-cloud-arrow-up fs-4"></i>
                            <span class="fw-bold small">Bulk Import</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script th:src="@{/js/duty-roster.js}"></script>
    <script th:src="@{/js/patient-registry.js}"></script>
    <script th:inline="javascript">
        // --- 1. CLOCK LOGIC ---
        function updateClock() {
            const clockEl = document.getElementById('current-time');
            if (!clockEl) return;
            const now = new Date();
            clockEl.textContent = now.toLocaleTimeString('en-US', {
                hour12: true,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- 2. REUSABLE LIVE SEARCH ---
        function liveSearch(inputId, itemClass, nameClass) {
            const input = document.getElementById(inputId).value.toLowerCase();
            const items = document.getElementsByClassName(itemClass);

            Array.from(items).forEach(item => {
                const nameEl = item.querySelector('.' + nameClass);
                if (nameEl) {
                    const nameText = nameEl.innerText.toLowerCase();
                    item.style.display = nameText.includes(input) ? "flex" : "none";
                }
            });
        }

        // --- 3. CHART INITIALIZATION ---
        const ctx = document.getElementById('refinedChart').getContext('2d');
        if (ctx) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['08 AM', '10 AM', '12 PM', '02 PM', '04 PM', '06 PM', '08 PM'],
                    datasets: [{
                        data: [35, 60, 45, 90, 65, 80, 50],
                        borderColor: '#0f4c81',
                        borderWidth: 4,
                        pointBackgroundColor: '#fff',
                        pointRadius: 6,
                        fill: true,
                        tension: 0.45,
                        backgroundColor: 'rgba(15, 76, 129, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function downloadChartCSV() {
            const chart = Chart.getChart("refinedChart");
            if (!chart) return;
            let csv = "Time,Inflow\n" + chart.data.labels.map((l, i) => `${l},${chart.data.datasets[0].data[i]}`).join("\n");
            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = `GopalOps_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>
</div>
</body>
</html>