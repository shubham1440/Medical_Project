<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>Consent Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        .form-switch .form-check-input {
            width: 2.5em;
            height: 1.5em;
        }
        .search-bar {
            max-width: 400px;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-5">
        <div class="card mb-3">
            <div class="card-header">
                <h3>Grant Consent to a Provider</h3>
            </div>
            <div class="card-body">
                <form method="post" th:action="@{/consent/grant}">
                    <div class="mb-3">
                        <label for="providerId" class="form-label">Provider</label>
                        <select class="form-select" id="providerId" name="providerId" required>
                            <option value="">Select Provider</option>
                            <option th:each="provider : ${providers}"
                                    th:value="${provider.id}"
                                    th:text="${provider.firstName + ' ' + provider.lastName + ' - ' + provider.specialty}">
                            </option>
                        </select>
                        <div th:if="${#lists.isEmpty(providers)}" class="text-danger mt-2">
                            No providers available to select.
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" th:disabled="${#lists.isEmpty(providers)}">Grant Consent</button>
                </form>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h3>Your Active Consents</h3>
            </div>
            <div class="card-body">
                <p>Use the slider to grant or revoke consent for each provider. Use the search bar to filter providers.</p>
                <!-- Search Bar -->
                <div class="mb-3">
                    <input id="providerSearch" type="text" class="form-control search-bar" placeholder="Search provider or specialty...">
                </div>
                <table class="table table-striped" id="consentTable">
                    <thead>
                    <tr>
                        <th>Provider (Name - Specialty)</th>
                        <th>Consent Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="consent : ${consents}">
                        <td th:text="${consent.provider.firstName + ' ' + consent.provider.lastName + ' - ' + consent.provider.specialty}">
                            Provider Name - Specialty
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input"
                                       type="checkbox"
                                       th:id="'consentSwitch-' + ${consent.provider.id}"
                                       th:checked="${consent.consentGranted}"
                                       th:onchange="'toggleConsent(' + ${consent.provider.id} + ',this.checked)'">
                                <label class="form-check-label"
                                       th:for="'consentSwitch-' + ${consent.provider.id}">
                                    <span th:text="${consent.consentGranted ? 'Granted' : 'Revoked'}"></span>
                                </label>
                            </div>
                        </td>
                    </tr>
                    <tr id="noConsentsRow" th:if="${#lists.isEmpty(consents)}">
                        <td colspan="2" class="text-center">No providers found.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        function toggleConsent(providerId, consentGiven) {
            fetch('/api/consent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ providerId, consentGiven })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Failed to update consent: ' + data.message);
                }
            })
            .catch(error => alert('Error: ' + error));
        }

        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('providerSearch');
            const consentTable = document.getElementById('consentTable');
            const noConsentsRow = document.getElementById('noConsentsRow');

            searchInput.addEventListener('input', function () {
                const search = this.value.trim().toLowerCase();
                const trs = consentTable.querySelectorAll('tbody tr');
                let visibleCount = 0;

                trs.forEach(function (tr) {
                    if (tr.id === 'noConsentsRow') return;
                    const text = tr.textContent.toLowerCase();
                    const show = text.includes(search);
                    tr.style.display = show ? '' : 'none';
                    if (show) visibleCount++;
                });

                if (noConsentsRow) {
                    if (visibleCount === 0) {
                        noConsentsRow.style.display = '';
                    } else {
                        noConsentsRow.style.display = 'none';
                    }
                }
            });
        });
    </script>
</div>
</body>
</html>
