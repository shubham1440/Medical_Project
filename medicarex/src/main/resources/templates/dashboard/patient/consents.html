<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Privacy Terminal | Gopal Hospital</title>
    <th:block layout:fragment="page-css">
        <link rel="stylesheet" th:href="@{/css/CDV1.css}">
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="container py-4">

        <div class="mb-5 d-flex align-items-center">
            <a th:href="@{/patient/dashboard}" class="btn-back shadow-sm me-3">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h3 class="terminal-header fw-800 mb-0">Privacy & Consent Terminal</h3>
        </div>

        <div class="row g-4">
            <div class="col-lg-3">
                <div class="bento-card shadow-sm border-0">
                    <h6 class="fw-800 mb-4 text-dark"><i class="bi bi-shield-plus me-2 text-primary"></i>Grant Access</h6>
                    <form method="post" th:action="@{/consent/grant}">
                        <div class="mb-4">
                            <label class="field-label">Select Physician</label>
                            <select class="form-select border-1 bg-light rounded-3 fw-600" name="providerId" required>
                                <option value="" disabled selected>Search Directory...</option>
                                <option th:each="p : ${providers}" th:value="${p.id}" th:text="${p.firstName + ' ' + p.lastName}"></option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-dark w-100 rounded-3 fw-700 py-2 shadow-sm">Initialize Access</button>
                    </form>
                </div>
            </div>

            <div class="col-lg-9">

                <div th:if="${PendingConsents != null and !#lists.isEmpty(PendingConsents)}">
                    <h5 class="fw-800 mb-4"><i class="bi bi-lightning-fill text-warning"></i> Pending Clinical Requests</h5>

                    <div th:each="request : ${PendingConsents}" th:id="'card-' + ${request.requestId}" class="bento-card request-alert-card mb-4">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="field-label">Requesting Provider</div>
                                <h5 class="fw-800 mb-0" th:text="${request.provider_name}">Doctor Name</h5>
                                <div class="text-muted small fw-600">ID: #<span th:text="${request.provider_id}">8</span></div>
                                <div class="mt-4">
                                    <div class="field-label">Clinical Reason</div>
                                    <p class="small fw-600 bg-white border p-3 rounded-3" th:text="${request.reason}">Reason text</p>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="field-label">Request Date</div>
                                <div class="small fw-700 mb-3" th:text="${request.createdAt != null ? #temporals.format(request.createdAt, 'dd MMM yyyy, HH:mm') : 'Recently'}">Date</div>
                                <div class="d-flex gap-2 justify-content-end">
                                    <button class="btn-reject" th:data-id="${request.requestId}" onclick="processRejection(this.getAttribute('data-id'))">Reject</button>
                                    <button class="btn-approve" th:data-id="${request.requestId}" onclick="processApproval(this.getAttribute('data-id'))">Approve</button>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" style="opacity: 0.05;">

                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <label class="field-label">Option A: Select from Vault</label>
                                <select th:id="'doc-select-' + ${request.requestId}" class="vault-select-custom mb-3">
                                    <option selected disabled value="">Choose available document...</option>
                                    <option th:each="doc : ${document}" th:value="${doc.id}" th:text="${doc.title}"></option>
                                </select>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="field-label mb-0">Set Expiry:</span>
                                    <select th:id="'expiry-select-' + ${request.requestId}" class="form-select form-select-sm w-auto fw-700">
                                        <option value="1">1 Hour</option>
                                        <option value="24" selected>24 Hours</option>
                                        <option value="168">1 Week</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <label class="field-label d-block">Option B: Upload New</label>
                                <div class="d-flex justify-content-end align-items-center gap-3">
                                    <div class="upload-icon-btn" th:data-id="${request.requestId}" onclick="triggerUpload(this.getAttribute('data-id'))">
                                        <i class="bi bi-cloud-arrow-up text-success fs-5"></i>
                                    </div>
                                    <input type="file" th:id="'file-input-' + ${request.requestId}" class="d-none"
                                           th:data-id="${request.requestId}" onchange="handleDirectUpload(this.getAttribute('data-id'))">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bento-card border-0 shadow-sm mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h6 class="fw-800 mb-0">Active Authorizations</h6>
                        <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3"
                              th:text="${#lists.size(autorizedConsents) + ' Active'}">0 Active</span>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                            <tr class="field-label text-muted border-0">
                                <th class="ps-0">Physician</th>
                                <th class="text-center">Status</th>
                                <th class="text-end pe-0">Action</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="consent : ${autorizedConsents}">
                                <td class="ps-0">
                                    <div class="fw-800 text-dark" th:text="${consent.providerName}">Provider Name</div>
                                </td>
                                <td class="text-center">
                                        <span class="badge rounded-pill fw-bold bg-success-subtle text-success border border-success-subtle px-3 py-2">
                                            ACTIVE
                                        </span>
                                </td>
                                <td class="text-end pe-0">
                                    <div class="form-check form-switch d-inline-block">
                                        <input class="form-check-input custom-switch" type="checkbox" checked
                                               th:data-id="${consent.id}"
                                               onchange="processRejection(this.getAttribute('data-id'))">
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(autorizedConsents)}">
                                <td colspan="3" class="text-center py-5 text-muted fw-600">
                                    <i class="bi bi-shield-slash d-block fs-2 mb-2 opacity-25"></i>
                                    No active authorizations found.
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="page-scripts">
    <script th:src="@{/js/CDV1.js}"></script>
</th:block>
</body>
</html>