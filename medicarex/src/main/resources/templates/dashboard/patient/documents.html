<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
<!--    <meta charset="UTF-8">-->
    <title>Health Vault | Gopal Hospital</title>
    <th:block layout:fragment="page-css">
        <link rel="stylesheet" th:href="@{/css/HVV1.css}">
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <a th:href="@{/patient/dashboard}" class="btn-back shadow-sm me-3" title="Back to Dashboard">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <p class="text-primary fw-800 mb-0 small text-uppercase" style="font-size: 0.7rem; letter-spacing: 1px;">Secure Storage</p>
                    <h3 class="terminal-header fw-800 mb-0">Health Vault</h3>
                </div>
            </div>
            <button class="btn btn-dark rounded-3 fw-700 px-4 py-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="bi bi-cloud-arrow-up-fill me-2"></i>Upload Record
            </button>
        </div>

        <div class="bento-card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="vaultTable">
                    <thead>
                    <tr class="field-label text-muted border-0">
                        <th class="ps-0" style="width: 45%">Document Name</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th class="text-end pe-0">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(documents)}">
                        <td colspan="4" class="text-center py-5 text-muted fw-600">
                            <i class="bi bi-folder2-open d-block fs-1 opacity-25 mb-2"></i>
                            No records found in your vault.
                        </td>
                    </tr>

                    <tr th:each="doc : ${documents}" class="doc-row">
                        <td class="ps-0">
                            <div class="d-flex align-items-center gap-3">
                                <div class="file-icon-box bg-light rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i th:class="${doc.fileSize == '0 B' ? 'bi bi-file-earmark-x text-danger' : 'bi bi-file-earmark-pdf-fill text-primary'}"></i>
                                </div>
                                <div>
                                    <div class="fw-800 text-dark" th:text="${doc.title}">Report.pdf</div>
                                    <small class="text-muted fw-600" th:text="${doc.fileSize}">2.4 MB</small>
                                </div>
                            </div>
                        </td>
                        <td>
                                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3 py-2 fw-700"
                                      th:text="${doc.category}">General</span>
                        </td>
                        <td>
                                <span th:if="${doc.fileSize != '0 B'}" class="badge rounded-pill fw-bold bg-success-subtle text-success border border-success-subtle px-3 py-2">
                                    <i class="bi bi-patch-check-fill me-1"></i> VERIFIED
                                </span>
                            <span th:unless="${doc.fileSize != '0 B'}" class="badge rounded-pill fw-bold bg-danger-subtle text-danger border border-danger-subtle px-3 py-2">
                                    <i class="bi bi-exclamation-triangle-fill me-1"></i> ERROR
                                </span>
                        </td>
                        <td class="text-end pe-0">

                            <button class="btn btn-outline-dark btn-sm rounded-pill px-4 fw-700 view-details-btn"
                                    th:data-id="${doc.id}"
                                    th:data-title="${doc.title}"
                                    th:data-size="${doc.fileSize}"
                            >
                                Examine
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-end border-0 shadow-lg" tabindex="-1" id="documentDrawer" style="width: 400px; border-radius: 24px 0 0 24px;">
        <div class="offcanvas-header pt-4 px-4">
            <h5 class="fw-800 mb-0">Record Overview</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-4 text-center">
            <div class="py-5 mb-4 bg-light rounded-4">
                <div class="file-icon-display mb-3">
                    <i class="bi bi-file-lock2-fill display-4 text-primary"></i>
                </div>
                <h4 id="drawerTitle" class="fw-800 mt-3 px-3 text-break">---</h4>
                <p id="drawerSize" class="text-muted fw-600 small">---</p>
            </div>

            <div class="d-grid gap-3" id="actionArea">
                <button id="popPanelBtn" class="btn btn-dark py-3 fw-800 rounded-3">
                    <i class="bi bi-window-fullscreen me-2"></i>Examine Document
                </button>

                <button id="viewNotesBtn" class="btn btn-outline-primary py-3 fw-800 rounded-3">
                    <i class="bi bi-chat-left-text me-2"></i>View Notes
                </button>

                <a id="downloadLink" href="#" class="btn btn-outline-dark py-3 fw-800 rounded-3">
                    <i class="bi bi-download me-2"></i>Download Original
                </a>
            </div>
        </div>
    </div>

    <div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-labelledby="previewTitle" aria-modal="true">
        <div class="modal-dialog modal-fullscreen p-4">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

                <div class="modal-header border-0 bg-dark text-white py-3 px-4">
                    <div class="d-flex align-items-center">
                        <div class="p-2 bg-primary bg-opacity-10 rounded-3 me-3">
                            <i class="bi bi-shield-check text-primary fs-4"></i>
                        </div>
                        <div>
                            <h6 class="modal-title fw-800 mb-0" id="previewTitle">Document Analysis</h6>
                            <small class="text-white-50 fw-600">Clinical Terminal Viewer v2.0</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-0 bg-light" style="height: calc(100vh - 140px); overflow: hidden;">
                    <div class="container-fluid h-100">
                        <div class="row h-100">

                            <div class="col-lg-8 p-0 border-end d-flex flex-column bg-secondary bg-opacity-5 h-100">
                                <div class="viewer-controls bg-white border-bottom p-2 d-flex justify-content-center align-items-center gap-3 shadow-sm">
                                    <button id="prevPage" class="btn btn-sm btn-outline-dark rounded-pill px-3 fw-700">
                                        <i class="bi bi-chevron-left me-1"></i> Previous
                                    </button>
                                    <div class="badge bg-dark rounded-pill px-3 py-2 fw-600">
                                        Page <span id="pageNum">1</span> / <span id="pageCount">-</span>
                                    </div>
                                    <button id="nextPage" class="btn btn-sm btn-outline-dark rounded-pill px-3 fw-700">
                                        Next <i class="bi bi-chevron-right ms-1"></i>
                                    </button>
                                </div>

                                <div id="pdf-viewer-container" class="flex-grow-1 overflow-auto p-4 d-flex justify-content-center align-items-start">
                                    <canvas id="pdf-render" class="shadow-lg bg-white border border-secondary border-opacity-10"></canvas>
                                </div>
                            </div>

                            <div class="col-lg-4 p-0 bg-white d-flex flex-column border-start h-100">
                                <div class="p-3 border-bottom bg-light">
                                    <h6 class="fw-800 text-uppercase tracking-wider small text-muted mb-0">Clinical Analysis Console</h6>
                                </div>

                                <div class="flex-grow-1 p-3 overflow-auto bg-light bg-opacity-50" style="max-height: 40%;">
                                    <label class="small fw-800 text-muted text-uppercase mb-2" style="font-size: 0.7rem;">Previous Prescription Chain</label>
                                    <div id="notesHistoryChain" class="d-flex flex-column gap-2">
                                        <div class="p-3 rounded-3 bg-white border border-secondary border-opacity-10 shadow-sm">
                                            <p id="previousNotesDisplay" class="small text-secondary mb-0" style="white-space: pre-wrap; line-height: 1.5;">
                                                No previous history found.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-3 border-top bg-white shadow-lg">
                                    <label class="small fw-800 text-primary text-uppercase mb-2" style="font-size: 0.7rem;">Current Session Remarks</label>
                                    <textarea id="clinicalNotesInput"
                                              class="form-control border-0 bg-light p-3 rounded-4 shadow-sm mb-3"
                                              style="height: 200px; resize: none; font-size: 0.9rem;"
                                              placeholder="Enter new prescription notes..."></textarea>

                                    <button id="saveNotesBtn" class="btn btn-dark w-100 rounded-pill fw-bold py-2 shadow-sm">
                                        <i class="bi bi-plus-circle me-2"></i> Append to Chain
                                    </button>

                                    <div id="saveStatus" class="text-success small fw-bold text-center mt-2 d-none">
                                        <i class="bi bi-check-circle-fill me-1"></i> Chain Updated
                                    </div>
                                </div>

                                <div class="p-3 bg-light border-top mt-auto">
                                    <div class="d-flex align-items-center text-success small fw-700" style="font-size: 0.75rem;">
                                        <i class="bi bi-shield-lock-fill me-2"></i> Verified Secure Session
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <form th:action="@{/documents/upload}" method="post" enctype="multipart/form-data" id="uploadForm">
                    <div class="modal-header border-0 pt-4 px-4">
                        <h5 class="fw-800 mb-0">Secure Record Upload</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="mb-4">
                            <label class="field-label">Select File</label>
                            <input type="file" name="file" id="fileInput" class="form-control rounded-3" required>
                            <div id="fileHelp" class="form-text mt-2 text-primary fw-600">
                                <i class="bi bi-info-circle me-1"></i> Maximum 20MB data allowed per upload.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="field-label">Category</label>
                            <select name="category" class="form-select rounded-3 fw-600">
                                <option value="Radiology">Radiology / Imaging</option>
                                <option value="Lab Report">Pathology / Blood Test</option>
                                <option value="Prescription">Doctor Prescription</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer border-0 p-4 pt-0">
                        <button type="submit" class="btn btn-dark w-100 py-3 fw-800 rounded-3" id="uploadBtn">
                            <span id="btnText">Upload Now</span>
                            <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<th:block layout:fragment="page-scripts">
    <script th:src="@{/js/HVV1.js}"></script>
</th:block>
</body>
</html>